{% extends 'base.html' %}

{% block title %}Просмотр персонажа {{ character.first_name }}{% endblock %}

{% block content %}
<h1>{{ character.first_name }} {{ character.last_name }}</h1>

<ul class="list-group mb-3">
  <li class="list-group-item"><strong>Возраст:</strong> {{ character.age or '—' }}</li>
  <li class="list-group-item"><strong>Группировка:</strong> {{ character.faction or '—' }}</li>
  <li class="list-group-item"><strong>Есть КПК:</strong> {{ 'Да' if character.has_pda else 'Нет' }}</li>
  <li class="list-group-item"><strong>Навыки и опыт:</strong><br>{{ character.skills_experience or '—' | nl2br }}</li>
  <li class="list-group-item"><strong>Состояние здоровья:</strong><br>{{ character.health_status or '—' | nl2br }}</li>
  <li class="list-group-item"><strong>Предыстория:</strong><br>{{ character.backstory or '—' | nl2br }}</li>
  <li class="list-group-item"><strong>Переносимый вес:</strong> {{ character.carry_weight or '—' }} кг</li>
</ul>

<!-- Блоки персонажа -->
<div class="container my-4 p-0">
  <h2>Блоки персонажа</h2>
  <div id="blocks-container" class="list-group">
    {% for block in character.blocks %}
      <div class="list-group-item d-flex justify-content-between align-items-center block-item" data-id="{{ block.id }}">
        <div>
          <strong>{{ block.type|capitalize }}</strong><br>
          {% if block.type == 'notes' %}
            <small>{{ block.data.get('text', '')[:50] }}...</small>
          {% elif block.type == 'inventory' %}
            <small>Размер: {{ block.settings.get('width', '?') }}×{{ block.settings.get('height', '?') }}</small>
          {% else %}
            <small>Доп. информация отсутствует</small>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<a href="{{ url_for('edit_character', char_id=character.id) }}" class="btn btn-warning">Редактировать</a>
<a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Назад к списку</a>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  const container = document.getElementById('blocks-container');
  const sortable = new Sortable(container, {
    animation: 150,
    onEnd: function (evt) {
      // Формируем массив с id блоков и новым порядком
      const order = [];
      container.querySelectorAll('.block-item').forEach((el, index) => {
        order.push({id: el.dataset.id, order: index});
      });

      // Отправляем на сервер для сохранения
      fetch('{{ url_for("update_blocks_order", char_id=character.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(order),
      })
      .then(response => {
        if (!response.ok) alert('Ошибка при сохранении порядка блоков');
      });
    },
  });
</script>
{% endblock %}