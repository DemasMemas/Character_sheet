<!-- templates/includes/_blocks.html -->
<div class="blocks-container mb-4">
  <!-- Форма добавления нового блока -->
  <div class="mb-3">
    <label for="blockTypeSelect" class="form-label">Добавить блок</label>
    <div class="input-group">
      <select id="blockTypeSelect" class="form-select" aria-label="Выберите тип блока">
        <option selected disabled>Выберите тип блока</option>
        <option value="inventory">Инвентарь</option>
        <option value="notes">Заметки</option>
        <option value="weapon">Оружие</option>
        <option value="armor">Броня</option>
        <option value="special_trait">Особая черта</option>
      </select>
      <button id="addBlockBtn" class="btn btn-primary" type="button">
        <i class="bi bi-plus-circle"></i> Добавить
      </button>
    </div>
  </div>

  <!-- Список блоков -->
  <ul id="blocksList" class="list-group sortable-blocks">
    {% for block in blocks %}
    <li class="list-group-item d-flex flex-column mb-2" data-block-id="{{ block.id }}">
      <!-- Заголовок блока -->
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span class="badge bg-secondary me-2">{{ loop.index }}</span>
          <strong>{{ block.type|capitalize }}</strong>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-warning edit-block-btn me-2">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger delete-block-btn">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>

      <!-- Форма редактирования (скрыта по умолчанию) -->
      <div class="edit-form-container mt-2 p-3 bg-light rounded" style="display: none;">
        {% if block.type == 'notes' %}
        <textarea class="form-control mb-2 block-data-input" rows="4"
                  placeholder="Введите текст заметки">{{ block.data.text if block.data.text else '' }}</textarea>
        {% elif block.type == 'inventory' %}
        <div class="row mb-2">
          <div class="col">
            <label>Ширина</label>
            <input type="number" class="form-control width-input" value="{{ block.settings.width if block.settings.width else 5 }}">
          </div>
          <div class="col">
            <label>Высота</label>
            <input type="number" class="form-control height-input" value="{{ block.settings.height if block.settings.height else 5 }}">
          </div>
        </div>
        {% endif %}

        <div class="d-flex justify-content-end">
          <button class="btn btn-sm btn-success save-block-btn me-2">
            <i class="bi bi-check"></i> Сохранить
          </button>
          <button class="btn btn-sm btn-secondary cancel-block-btn">
            <i class="bi bi-x"></i> Отмена
          </button>
        </div>
      </div>

      <!-- Превью содержимого -->
      <div class="block-preview mt-2">
        {% if block.type == 'notes' and block.data.text %}
        <p class="mb-0 text-muted">{{ block.data.text|truncate(100) }}</p>
        {% elif block.type == 'inventory' %}
        <small class="text-muted">
          Размер: {{ block.settings.width if block.settings.width else '?' }}×{{ block.settings.height if block.settings.height else '?' }}
        </small>
        {% endif %}
      </div>
    </li>
    {% else %}
    <li class="list-group-item text-muted">Блоки пока не добавлены</li>
    {% endfor %}
  </ul>
</div>

<!-- Общий JavaScript для работы с блоками -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Добавление нового блока
  document.getElementById('addBlockBtn')?.addEventListener('click', function() {
    const select = document.getElementById('blockTypeSelect');
    const blockType = select.value;

    if (!blockType) {
      alert('Пожалуйста, выберите тип блока');
      return;
    }

    fetch('{{ url_for("add_block_ajax", char_id=character.id) }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ block_type: blockType })
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
        return;
      }

      const blocksList = document.getElementById('blocksList');
      const emptyItem = blocksList.querySelector('li.list-group-item:not([data-block-id])');

      if (emptyItem && emptyItem.textContent.includes('не добавлены')) {
        emptyItem.remove();
      }

      const newBlock = document.createElement('li');
      newBlock.className = 'list-group-item d-flex flex-column mb-2';
      newBlock.dataset.blockId = data.id;
      newBlock.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <span class="badge bg-secondary me-2">${blocksList.children.length + 1}</span>
            <strong>${data.type.charAt(0).toUpperCase() + data.type.slice(1)}</strong>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-warning edit-block-btn me-2">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger delete-block-btn">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
        <div class="edit-form-container mt-2 p-3 bg-light rounded" style="display: none;">
          ${blockType === 'notes' ?
            '<textarea class="form-control mb-2 block-data-input" rows="4" placeholder="Введите текст заметки"></textarea>' :
            '<div class="row mb-2"><div class="col"><label>Ширина</label><input type="number" class="form-control width-input" value="5"></div><div class="col"><label>Высота</label><input type="number" class="form-control height-input" value="5"></div></div>'
          }
          <div class="d-flex justify-content-end">
            <button class="btn btn-sm btn-success save-block-btn me-2">
              <i class="bi bi-check"></i> Сохранить
            </button>
            <button class="btn btn-sm btn-secondary cancel-block-btn">
              <i class="bi bi-x"></i> Отмена
            </button>
          </div>
        </div>
        <div class="block-preview mt-2 text-muted">
          ${blockType === 'inventory' ? '<small>Размер: 5×5</small>' : ''}
        </div>
      `;

      blocksList.appendChild(newBlock);
      select.value = '';
    })
    .catch(error => {
      console.error('Ошибка:', error);
      alert('Не удалось добавить блок');
    });
  });

  // Делегирование событий для всей списка блоков
  document.getElementById('blocksList')?.addEventListener('click', function(e) {
    const blockItem = e.target.closest('li[data-block-id]');
    if (!blockItem) return;

    const blockId = blockItem.dataset.blockId;

    // Удаление блока
    if (e.target.closest('.delete-block-btn')) {
      if (!confirm('Удалить этот блок?')) return;

      fetch(`/block/${blockId}/delete`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          blockItem.remove();

          // Если блоков не осталось, показываем заглушку
          if (!document.querySelector('li[data-block-id]')) {
            const blocksList = document.getElementById('blocksList');
            const emptyItem = document.createElement('li');
            emptyItem.className = 'list-group-item text-muted';
            emptyItem.textContent = 'Блоки пока не добавлены';
            blocksList.appendChild(emptyItem);
          }
        } else {
          alert(data.error || 'Ошибка при удалении');
        }
      })
      .catch(() => alert('Ошибка соединения'));
    }

    // Редактирование блока
    if (e.target.closest('.edit-block-btn')) {
      blockItem.querySelector('.edit-form-container').style.display = 'block';
    }

    // Отмена редактирования
    if (e.target.closest('.cancel-block-btn')) {
      blockItem.querySelector('.edit-form-container').style.display = 'none';
    }

    // Сохранение блока
    if (e.target.closest('.save-block-btn')) {
      const formContainer = blockItem.querySelector('.edit-form-container');
      const blockType = blockItem.querySelector('strong').textContent.toLowerCase();

      let data = {};
      let settings = {};

      if (blockType === 'notes') {
        data = { text: formContainer.querySelector('.block-data-input').value };
      } else if (blockType === 'inventory') {
        settings = {
          width: parseInt(formContainer.querySelector('.width-input').value),
          height: parseInt(formContainer.querySelector('.height-input').value)
        };
      }

      fetch(`/block/${blockId}/edit`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
          data: data,
          settings: settings
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          formContainer.style.display = 'none';

          // Обновляем превью
          if (blockType === 'notes') {
            blockItem.querySelector('.block-preview').innerHTML =
              `<p class="mb-0 text-muted">${data.text?.substring(0, 100) || ''}</p>`;
          } else if (blockType === 'inventory') {
            blockItem.querySelector('.block-preview').innerHTML =
              `<small class="text-muted">Размер: ${settings.width}×${settings.height}</small>`;
          }
        } else {
          alert(data.error || 'Ошибка сохранения');
        }
      })
      .catch(() => alert('Ошибка соединения'));
    }
  });

  // Сортировка блоков
  new Sortable(document.querySelector('.sortable-blocks'), {
    animation: 150,
    handle: '.badge',
    onEnd: function() {
      const order = Array.from(document.querySelectorAll('li[data-block-id]')).map((el, index) => ({
        id: el.dataset.blockId,
        order: index + 1
      }));

      fetch('{{ url_for("update_blocks_order", char_id=character.id) }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(order)
      }).catch(() => alert('Ошибка сохранения порядка'));
    }
  });
});
</script>
<script>
function getCSRFToken() {
    return document.cookie.split('; ')
        .find(row => row.startsWith('csrf_token='))
        ?.split('=')[1];
}
</script>