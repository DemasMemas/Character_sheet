<div class="block"
     data-block-id="{{ block.id }}"
     data-block-type="{{ block.type }}"
     style="left: {{ block.position_x }}px;
            top: {{ block.position_y }}px;
            width: {{ block.width }}px;
            height: {{ block.height }}px;
            background-color: {{ block.color }};">

  <div class="block-header">
    {% if block.type == 'text' or block.type == 'weapon' or block.type == 'armor' or
          block.type == 'inventory' or block.type == 'character_info' or
          block.type == 'helmet' or block.type == 'table' %}
      <div class="block-title editable-field" contenteditable="true" data-field="name">
        {{ block.data.get('name', '–ù–æ–≤—ã–π –±–ª–æ–∫') }}
      </div>
    {% else %}
      <div class="block-title">{{ block.type }}</div>
    {% endif %}

    <div class="block-actions">
      <button class="btn btn-sm btn-outline-secondary color-trigger">üé®</button>
      <button class="btn btn-sm btn-danger delete-block">√ó</button>
    </div>
  </div>

  <div class="block-content">
    {% if block.type == 'text' %}
      <div class="editable-field" contenteditable="true" data-field="content">
        {{ block.data.get('content', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å...') }}
      </div>

    {% elif block.type == 'weapon' %}
      <div class="mb-2">
        <label>–£—Ä–æ–Ω:</label>
        <span class="editable-field" contenteditable="true" data-field="damage">
          {{ block.data.get('damage', '10') }}
        </span>
      </div>
      <div class="mb-2">
        <label>–¢–æ—á–Ω–æ—Å—Ç—å:</label>
        <span class="editable-field" contenteditable="true" data-field="accuracy">
          {{ block.data.get('accuracy', '75') }}
        </span>%
      </div>
      <div class="mb-2">
        <label>–í–µ—Å:</label>
        <span class="editable-field" contenteditable="true" data-field="weight">
          {{ block.data.get('weight', '3.5') }}
        </span> –∫–≥
      </div>
      <div class="action-buttons mt-3">
        <button class="btn btn-sm btn-primary action-btn" data-action="roll_attack">
          –ê—Ç–∞–∫–æ–≤–∞—Ç—å (D20)
        </button>
      </div>

    {% elif block.type == 'armor' %}
      <div class="mb-2">
        <label>–ó–∞—â–∏—Ç–∞:</label>
        <span class="editable-field" contenteditable="true" data-field="defense">
          {{ block.data.get('defense', '5') }}
        </span>
      </div>
      <div class="mb-2">
        <label>–ü—Ä–æ—á–Ω–æ—Å—Ç—å:</label>
        <span class="editable-field" contenteditable="true" data-field="durability">
          {{ block.data.get('durability', '100') }}
        </span>
      </div>
      <div class="mb-2">
        <label>–í–µ—Å:</label>
        <span class="editable-field" contenteditable="true" data-field="armor_weight">
          {{ block.data.get('armor_weight', '8.5') }}
        </span> –∫–≥
      </div>

    {% elif block.type == 'helmet' %}
      <div class="mb-2">
        <label>–ó–∞—â–∏—Ç–∞ –≥–æ–ª–æ–≤—ã:</label>
        <span class="editable-field" contenteditable="true" data-field="head_defense">
          {{ block.data.get('head_defense', '3') }}
        </span>
      </div>
      <div class="mb-2">
        <label>–®—Ç—Ä–∞—Ñ –∫ –æ–±–∑–æ—Ä—É:</label>
        <span class="editable-field" contenteditable="true" data-field="vision_penalty">
          {{ block.data.get('vision_penalty', '10') }}
        </span>%
      </div>
      <div class="mb-2">
        <label>–í–µ—Å:</label>
        <span class="editable-field" contenteditable="true" data-field="helmet_weight">
          {{ block.data.get('helmet_weight', '2.5') }}
        </span> –∫–≥
      </div>

    {% elif block.type == 'inventory' %}
      <div class="mb-2">
        <label>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:</label>
        <span class="editable-field" contenteditable="true" data-field="capacity">
          {{ block.data.get('capacity', '50') }}
        </span> –∫–≥
      </div>
      <div class="mt-3">
        <button class="btn btn-sm btn-outline-success add-item-btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
      </div>
      <div class="items-container mt-2">
        {% for item in block.data.get('items', []) %}
          <div class="item mb-2 p-2 border">
            <div class="d-flex justify-content-between">
              <div>
                <span class="editable-field" contenteditable="true" data-field="items.{{ loop.index0 }}.name">
                  {{ item.get('name', '–ü—Ä–µ–¥–º–µ—Ç') }}
                </span>
              </div>
              <button class="btn btn-sm btn-danger delete-item">√ó</button>
            </div>
            <div class="row mt-1">
              <div class="col">
                <label>–ö–æ–ª-–≤–æ:</label>
                <span class="editable-field" contenteditable="true" data-field="items.{{ loop.index0 }}.quantity">
                  {{ item.get('quantity', 1) }}
                </span>
              </div>
              <div class="col">
                <label>–í–µ—Å:</label>
                <span class="editable-field" contenteditable="true" data-field="items.{{ loop.index0 }}.weight">
                  {{ item.get('weight', 0.1) }}
                </span> –∫–≥
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

    {% elif block.type == 'character_info' %}
      <div class="mb-2">
        <label>–ò–º—è:</label>
        <span class="editable-field" contenteditable="true" data-field="first_name">
          {{ character.first_name }}
        </span>
      </div>
      <div class="mb-2">
        <label>–§–∞–º–∏–ª–∏—è:</label>
        <span class="editable-field" contenteditable="true" data-field="last_name">
          {{ character.last_name }}
        </span>
      </div>
      <div class="mb-2">
        <label>–í–æ–∑—Ä–∞—Å—Ç:</label>
        <span class="editable-field" contenteditable="true" data-field="age">
          {{ character.age or '‚Äî' }}
        </span>
      </div>
      <div class="mb-2">
        <label>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:</label>
        <span class="editable-field" contenteditable="true" data-field="faction">
          {{ character.faction or '‚Äî' }}
        </span>
      </div>
      <div class="mb-2">
        <label>–ü–µ—Ä–µ–Ω–æ—Å–∏–º—ã–π –≤–µ—Å:</label>
        <span class="editable-field" contenteditable="true" data-field="carry_weight">
          {{ character.carry_weight or '‚Äî' }}
        </span> –∫–≥
      </div>

      {% elif block.type == 'table' %}
      {% set bg_color = block.data.get('bg_color', block.color) if block.data else block.color %}
      <div class="table-container" style="background-color: {{ bg_color }}; border-radius: 8px; padding: 8px;">
          <div class="table-responsive">
              <table class="table table-sm" style="background-color: transparent;">
                  <thead>
                      <tr>
                          {% for header in block.data.get('headers', ['–ù–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü']) %}
                              <th style="background-color: {{ bg_color }};">
                                  <div class="d-flex justify-content-between align-items-center">
                                      <div class="editable-field" contenteditable="true"
                                           data-field="header_{{ loop.index0 }}">{{ header }}</div>
                                      <button class="btn btn-sm btn-outline-danger delete-col-btn action-button"
                                              data-col-index="{{ loop.index0 }}">√ó</button>
                                  </div>
                              </th>
                          {% endfor %}
                          <th class="align-middle" style="background-color: {{ bg_color }};">
                              <button class="btn btn-sm btn-outline-success add-column action-button">+</button>
                          </th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for row in block.data.get('rows', [['–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞']]) %}
                          <tr class="table-row">
                              {% for cell in row %}
                                  <td style="background-color: {{ bg_color }};">
                                      <div class="editable-field" contenteditable="true"
                                           data-field="row_{{ loop.index0 }}_col_{{ loop.index0 }}">{{ cell }}</div>
                                  </td>
                              {% endfor %}
                              <td class="align-middle text-center" style="background-color: {{ bg_color }};">
                                  <button class="btn btn-sm btn-outline-danger delete-row-btn action-button"
                                          data-row-index="{{ loop.index0 }}">√ó</button>
                              </td>
                          </tr>
                      {% endfor %}
                  </tbody>
              </table>
          </div>
          <button class="btn btn-sm btn-outline-primary add-row mt-2">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
      </div>
      {% endif %}

    <div class="color-picker">
        <div class="color-option" data-color="#ffffff" title="–ë–µ–ª—ã–π"></div>
        <div class="color-option" data-color="#ffebee" title="–ö—Ä–∞—Å–Ω—ã–π"></div>
        <div class="color-option" data-color="#f3e5f5" title="–§–∏–æ–ª–µ—Ç–æ–≤—ã–π"></div>
        <div class="color-option" data-color="#e8eaf6" title="–°–∏–Ω–∏–π"></div>
        <div class="color-option" data-color="#e3f2fd" title="–ì–æ–ª—É–±–æ–π"></div>
        <div class="color-option" data-color="#e0f7fa" title="–ë–∏—Ä—é–∑–æ–≤—ã–π"></div>
        <div class="color-option" data-color="#e8f5e9" title="–ó–µ–ª–µ–Ω—ã–π"></div>
        <div class="color-option" data-color="#fffde7" title="–ñ–µ–ª—Ç—ã–π"></div>
        <div class="color-option" data-color="#fff3e0" title="–û—Ä–∞–Ω–∂–µ–≤—ã–π"></div>
        <div class="color-option" data-color="#efebe9" title="–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π"></div>
        <div class="color-option" data-color="#d3d3d3" title="–°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π"></div>
        <div class="color-option" data-color="#a9a9a9" title="–¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π"></div>
    </div>
  </div>
</div>
<style>
/* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–∞–ª–∏—Ç—Ä—ã */
.color-picker {
    display: none;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    position: absolute;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    width: 180px; /* –ù–µ–º–Ω–æ–≥–æ —à–∏—Ä–µ */
    border: 1px solid #dee2e6;
}

.color-option {
    width: 28px;  /* –£–≤–µ–ª–∏—á–∏–º —Ä–∞–∑–º–µ—Ä */
    height: 28px; /* –£–≤–µ–ª–∏—á–∏–º —Ä–∞–∑–º–µ—Ä */
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid rgba(0,0,0,0.1); /* –î–æ–±–∞–≤–∏–º –≥—Ä–∞–Ω–∏—Ü—É */
    transition: transform 0.2s, border-color 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* –¢–µ–Ω—å –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏ */
    flex-shrink: 0;
}

.color-option:hover {
    transform: scale(1.2);
    border-color: #000;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

/* –Ø—Ä–∫–∏–µ –≤–µ—Ä—Å–∏–∏ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∞–ª–∏—Ç—Ä–µ */
.color-option[data-color="#ffffff"] { background-color: #ffffff !important; }
.color-option[data-color="#ffebee"] { background-color: #ff5252 !important; }
.color-option[data-color="#f3e5f5"] { background-color: #e040fb !important; }
.color-option[data-color="#e8eaf6"] { background-color: #536dfe !important; }
.color-option[data-color="#e3f2fd"] { background-color: #40c4ff !important; }
.color-option[data-color="#e0f7fa"] { background-color: #18ffff !important; }
.color-option[data-color="#e8f5e9"] { background-color: #69f0ae !important; }
.color-option[data-color="#fffde7"] { background-color: #ffff00 !important; }
.color-option[data-color="#fff3e0"] { background-color: #ffab40 !important; }
.color-option[data-color="#efebe9"] { background-color: #d7ccc8 !important; }
.color-option[data-color="#d3d3d3"] { background-color: #808080 !important; }
.color-option[data-color="#a9a9a9"] { background-color: #505050 !important; }
</style>