{% extends 'base.html' %}

{% block title %}Редактировать персонажа {{ character.first_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1>Редактировать персонажа {{ character.first_name }} {{ character.last_name }}</h1>

  <form method="POST" action="">
    <div class="mb-3">
      <label for="first_name" class="form-label">Имя</label>
      <input type="text" class="form-control" id="first_name" name="first_name" required value="{{ character.first_name }}">
    </div>
    <div class="mb-3">
      <label for="last_name" class="form-label">Фамилия</label>
      <input type="text" class="form-control" id="last_name" name="last_name" required value="{{ character.last_name }}">
    </div>
    <div class="mb-3">
      <label for="age" class="form-label">Возраст</label>
      <input type="number" class="form-control" id="age" name="age" min="0" value="{{ character.age or '' }}">
    </div>
    <div class="mb-3">
      <label for="faction" class="form-label">Группировка</label>
      <input type="text" class="form-control" id="faction" name="faction" value="{{ character.faction or '' }}">
    </div>
    <div class="form-check mb-3">
      <input type="checkbox" class="form-check-input" id="has_pda" name="has_pda" {% if character.has_pda %}checked{% endif %}>
      <label class="form-check-label" for="has_pda">Имеется ПДА</label>
    </div>
    <div class="mb-3">
      <label for="skills_experience" class="form-label">Навыки и опыт</label>
      <textarea class="form-control" id="skills_experience" name="skills_experience" rows="3">{{ character.skills_experience or '' }}</textarea>
    </div>
    <div class="mb-3">
      <label for="health_status" class="form-label">Состояние здоровья</label>
      <textarea class="form-control" id="health_status" name="health_status" rows="3">{{ character.health_status or '' }}</textarea>
    </div>
    <div class="mb-3">
      <label for="backstory" class="form-label">Предыстория</label>
      <textarea class="form-control" id="backstory" name="backstory" rows="4">{{ character.backstory or '' }}</textarea>
    </div>
    <div class="mb-3">
      <label for="carry_weight" class="form-label">Максимальный вес переносимого снаряжения</label>
      <input type="number" step="0.1" class="form-control" id="carry_weight" name="carry_weight" value="{{ character.carry_weight or '' }}">
    </div>

    <button type="submit" class="btn btn-primary mb-4">Сохранить персонажа</button>
  </form>

  <hr>

  {% if character.id %}
  <div class="mb-3">
    <label for="blockTypeSelect" class="form-label">Добавить блок</label>
    <select id="blockTypeSelect" class="form-select" aria-label="Выберите тип блока">
      <option selected disabled>Выберите тип блока</option>
      <option value="inventory">Инвентарь</option>
      <option value="notes">Заметки</option>
      <option value="weapon">Оружие</option>
      <option value="armor">Броня</option>
      <option value="special_trait">Особая черта</option>
    </select>
    <button id="addBlockBtn" class="btn btn-primary mt-2">Добавить блок</button>
  </div>

  <ul id="blocksList" class="list-group">
  {% for block in blocks %}
  <li class="list-group-item d-flex flex-column" data-block-id="{{ block.id }}">
    <div class="d-flex justify-content-between align-items-center">
      <span><strong>{{ block.type }}</strong></span>
      <div>
        <button class="btn btn-sm btn-warning edit-block-btn me-2">Редактировать</button>
        <button class="btn btn-sm btn-danger delete-block-btn">Удалить</button>
      </div>
    </div>
    <div class="edit-form-container mt-2" style="display:none;">
      <textarea class="form-control mb-2 data-input" rows="4" placeholder="Текст заметок">{{ block.data.note or '' }}</textarea>
      <button class="btn btn-sm btn-success save-block-btn">Сохранить</button>
      <button class="btn btn-sm btn-secondary cancel-block-btn">Отмена</button>
    </div>
  </li>
  {% else %}
  <li class="list-group-item">Блоки пока не добавлены</li>
  {% endfor %}
</ul>
  {% else %}
  <p>Сохраните персонажа, чтобы добавить блоки.</p>
  {% endif %}
</div>

<script>
document.getElementById('addBlockBtn')?.addEventListener('click', function() {
  const select = document.getElementById('blockTypeSelect');
  const blockType = select.value;
  if (!blockType) {
    alert('Пожалуйста, выберите тип блока');
    return;
  }

  fetch('{{ url_for("add_block_ajax", char_id=character.id) }}', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({block_type: blockType})
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }

    const ul = document.getElementById('blocksList');
    const emptyItem = ul.querySelector('li.list-group-item');
    if (emptyItem && emptyItem.textContent.trim() === 'Блоки пока не добавлены') {
      emptyItem.remove();
    }

    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.dataset.blockId = data.id;
    li.innerHTML = `
      <span><strong>${data.type}</strong></span>
      <div>
        <button class="btn btn-sm btn-warning edit-block-btn me-2">Редактировать</button>
        <button class="btn btn-sm btn-danger delete-block-btn">Удалить</button>
      </div>
    `;
    ul.appendChild(li);

    select.value = '';
  })
  .catch(() => alert('Ошибка при добавлении блока'));
});
</script>
<script>
document.addEventListener('click', function(event) {
  if (event.target.matches('.delete-block-btn')) {
    const li = event.target.closest('li[data-block-id]');
    const blockId = li.dataset.blockId;

    if (confirm('Удалить этот блок?')) {
      fetch(`/block/${blockId}/delete`, {method: 'POST'})
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            li.remove();
          } else {
            alert(data.error || 'Ошибка удаления блока');
          }
        })
        .catch(() => alert('Ошибка соединения'));
    }
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.edit-block-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const li = btn.closest('li');
      const form = li.querySelector('.edit-form-container');
      form.style.display = 'block';
    });
  });

  document.querySelectorAll('.cancel-block-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const form = btn.closest('.edit-form-container');
      form.style.display = 'none';
    });
  });

  document.querySelectorAll('.save-block-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const form = btn.closest('.edit-form-container');
    const li = btn.closest('li');
    const blockId = li.dataset.blockId;
    const noteText = form.querySelector('.data-input').value;

    fetch(`/block/${blockId}/edit`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({data: {note: noteText}})
    })
    .then(resp => resp.json())
    .then(result => {
      if(result.error) {
        alert(result.error);
      } else {
        form.style.display = 'none';
      }
    })
    .catch(() => alert('Ошибка сохранения'));
  });
});
});
</script>
{% endblock %}