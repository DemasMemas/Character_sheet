{% extends 'base.html' %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ {{ character.first_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ {{ character.first_name }} {{ character.last_name }}</h1>

  <form method="POST" action="">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (—Å–∫—Ä—ã—Ç—ã, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –≤ –±–ª–æ–∫–∞—Ö) -->
    <input type="hidden" name="first_name" value="{{ character.first_name }}">
    <input type="hidden" name="last_name" value="{{ character.last_name }}">
    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è -->

    <button type="submit" class="btn btn-primary mb-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
  </form>

  <!-- –°—Ç–∏–ª–∏ –¥–ª—è –¥–æ—Å–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ -->
  <style>
    .action-button {
      opacity: 0.3;
      transition: opacity 0.2s ease;
    }

    th:hover .action-button,
    .table-row:hover .action-button {
      opacity: 1;
    }

    th {
      vertical-align: middle !important;
    }

    td.align-middle {
      vertical-align: middle !important;
    }

    .character-board {
      position: relative;
      width: 100%;
      height: 80vh;
      min-height: 500px;
      border: 2px dashed #ccc;
      background-color: #f8f9fa;
      border-radius: 8px;
      overflow: auto;
      margin-bottom: 20px;
    }

    .block {
      position: absolute;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      background-color: #ffffff;
      resize: both;
      overflow: hidden;
      min-width: 250px;
      min-height: 150px;
      z-index: 10;
      transition: box-shadow 0.3s ease;
    }

    .block:hover {
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      z-index: 100;
    }

    .block-header {
      cursor: move;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .block-title {
      font-weight: bold;
      font-size: 1.1rem;
      flex-grow: 1;
    }

    .block-actions {
      display: flex;
      gap: 5px;
    }

    .block-content {
      overflow-y: auto;
      max-height: calc(100% - 40px);
    }

    .editable-field {
      padding: 4px 8px;
      border: 1px dashed transparent;
      border-radius: 4px;
      margin-bottom: 5px;
    }

    .editable-field:hover {
      border-color: #86b7fe;
      background-color: rgba(134, 183, 254, 0.1);
    }

    .block-palette {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 15px;
      background-color: #f1f3f5;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .block-type-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100px;
      height: 80px;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .block-type-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .block-type-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .color-picker {
      display: flex;
      gap: 5px;
      margin-top: 10px;
    }

    .color-option {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .color-option.active {
      border-color: #000;
    }

    .resize-handle {
      position: absolute;
      right: 5px;
      bottom: 5px;
      width: 15px;
      height: 15px;
      cursor: se-resize;
      font-size: 12px;
      opacity: 0.7;
      z-index: 100;
      text-align: center;
      line-height: 15px;
      background-color: #007bff;
      color: white;
      border-radius: 3px;
      pointer-events: all;
      user-select: none;
    }
  </style>

  <!-- –î–æ—Å–∫–∞ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ -->
  <div class="character-board" id="character-board">
    {% for block in root_blocks %}
      {% include 'edit_block.html' %}
    {% endfor %}
  </div>

  <!-- –ü–∞–ª–∏—Ç—Ä–∞ –±–ª–æ–∫–æ–≤ -->
  <div class="block-palette">
    <div class="block-type-btn" data-type="text">
      <div class="block-type-icon">üìù</div>
      <div>–¢–µ–∫—Å—Ç</div>
    </div>

    <div class="block-type-btn" data-type="weapon">
      <div class="block-type-icon">üî´</div>
      <div>–û—Ä—É–∂–∏–µ</div>
    </div>

    <div class="block-type-btn" data-type="armor">
      <div class="block-type-icon">üõ°Ô∏è</div>
      <div>–ë—Ä–æ–Ω—è</div>
    </div>

    <div class="block-type-btn" data-type="helmet">
      <div class="block-type-icon">‚õëÔ∏è</div>
      <div>–®–ª–µ–º</div>
    </div>

    <div class="block-type-btn" data-type="inventory">
      <div class="block-type-icon">üéí</div>
      <div>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
    </div>

    <div class="block-type-btn" data-type="character_info">
      <div class="block-type-icon">üë§</div>
      <div>–ò–Ω—Ñ–æ</div>
    </div>

    <div class="block-type-btn" data-type="table">
      <div class="block-type-icon">üìä</div>
      <div>–¢–∞–±–ª–∏—Ü–∞</div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ë–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const board = document.getElementById('character-board');
    const characterId = {{ character.id }};
    let isDragging = false;
    let currentBlock = null;

    // 1. –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–ª–æ–∫–∞
    function saveBlock(block) {
        const blockId = block.dataset.blockId;
        const blockType = block.dataset.blockType;
        const blockData = {};

        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π
        block.querySelectorAll('[contenteditable="true"]').forEach(field => {
            const fieldName = field.dataset.field;
            blockData[fieldName] = field.textContent;
        });

        // –î–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è —Å–æ–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã
        if (blockType === 'inventory') {
            blockData.items = [];
            block.querySelectorAll('.item').forEach(item => {
                const itemName = item.querySelector('[data-field$=".name"]')?.textContent || '–ü—Ä–µ–¥–º–µ—Ç';
                const itemQuantity = item.querySelector('[data-field$=".quantity"]')?.textContent || '1';
                const itemWeight = item.querySelector('[data-field$=".weight"]')?.textContent || '0.1';

                blockData.items.push({
                    name: itemName,
                    quantity: itemQuantity,
                    weight: itemWeight
                });
            });
        }

        // –î–ª—è —Ç–∞–±–ª–∏—Ü —Å–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        if (blockType === 'table') {
            blockData.headers = [];
            blockData.rows = [];

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            block.querySelectorAll('thead .editable-field').forEach(header => {
                blockData.headers.push(header.textContent);
            });

            // –°—Ç—Ä–æ–∫–∏
            block.querySelectorAll('tbody tr').forEach(row => {
                const rowData = [];
                row.querySelectorAll('td .editable-field').forEach(cell => {
                    rowData.push(cell.textContent);
                });
                blockData.rows.push(rowData);
            });
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const postData = {
            width: parseInt(block.offsetWidth),
            height: parseInt(block.offsetHeight),
            position_x: parseInt(block.style.left),
            position_y: parseInt(block.style.top),
            color: block.style.backgroundColor,
            block_data: blockData
        };

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch(`/block/${blockId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrfToken
            },
            body: JSON.stringify(postData)
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Block ${blockId} saved`);
        });
    }

    // 2. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –±–ª–æ–∫–æ–≤
    function makeBlockDraggable(block) {
        const header = block.querySelector('.block-header');
        if (!header) return;

        header.addEventListener('mousedown', startDrag);

        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            currentBlock = block;

            const startX = e.clientX;
            const startY = e.clientY;
            const startLeft = parseInt(block.style.left) || 0;
            const startTop = parseInt(block.style.top) || 0;

            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);

            function drag(e) {
                if (!isDragging) return;

                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                block.style.left = `${startLeft + dx}px`;
                block.style.top = `${startTop + dy}px`;
            }

            function stopDrag() {
                isDragging = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
                saveBlock(block);
            }
        }
    }

    // 3. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤
    function makeBlockResizable(block) {
        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'resize-handle';
        resizeHandle.innerHTML = '‚Üò';
        block.appendChild(resizeHandle);

        resizeHandle.addEventListener('mousedown', startResize);

        function startResize(e) {
            e.preventDefault();
            e.stopPropagation();

            const startWidth = block.offsetWidth;
            const startHeight = block.offsetHeight;
            const startX = e.clientX;
            const startY = e.clientY;

            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);

            function resize(e) {
                const width = startWidth + (e.clientX - startX);
                const height = startHeight + (e.clientY - startY);

                block.style.width = `${Math.max(200, width)}px`;
                block.style.height = `${Math.max(150, height)}px`;
            }

            function stopResize() {
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
                saveBlock(block);
            }
        }
    }

    // 4. –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
    function makeContentEditable(block) {
        block.querySelectorAll('[contenteditable="true"]').forEach(field => {
            field.addEventListener('blur', () => saveBlock(block));

            field.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    field.blur();
                }
            });
        });
    }

    // 5. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
    function initActionButtons(block) {
        // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
        block.querySelectorAll('.delete-row-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const rowIndex = parseInt(this.dataset.rowIndex);
            const tbody = block.querySelector('tbody');

            if (tbody.rows.length <= 1) {
              if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É?')) return;
            }

            tbody.deleteRow(rowIndex);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –≤ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∫–Ω–æ–ø–∫–∞—Ö
            tbody.querySelectorAll('.delete-row-btn').forEach((btn, i) => {
              btn.dataset.rowIndex = i;
            });

            saveBlock(block);
          });
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞
        block.querySelectorAll('.delete-col-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const colIndex = parseInt(this.dataset.colIndex);
            const thead = block.querySelector('thead');
            const tbody = block.querySelector('tbody');

            if (thead.rows[0].cells.length <= 2) { // 2 = —Å—Ç–æ–ª–±–µ—Ü + –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
              if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü?')) return;
            }

            // –£–¥–∞–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
            thead.rows[0].deleteCell(colIndex);

            // –£–¥–∞–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü –≤–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫–∞—Ö
            tbody.querySelectorAll('tr').forEach(row => {
              row.deleteCell(colIndex);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –≤ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∫–Ω–æ–ø–∫–∞—Ö
            thead.querySelectorAll('.delete-col-btn').forEach((btn, i) => {
              btn.dataset.colIndex = i;
            });

            saveBlock(block);
          });
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        const addRowBtn = block.querySelector('.add-row');
        if (addRowBtn) {
          addRowBtn.addEventListener('click', function() {
            const tbody = block.querySelector('tbody');
            const colCount = tbody.rows[0]?.cells?.length - 1 || 1; // –ò—Å–∫–ª—é—á–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü —Å –∫–Ω–æ–ø–∫–æ–π
            const rowIndex = tbody.rows.length;

            const newRow = document.createElement('tr');

            // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
            for (let i = 0; i < colCount; i++) {
              const cell = document.createElement('td');
              const field = document.createElement('div');
              field.className = 'editable-field';
              field.contentEditable = true;
              field.dataset.field = `row_${rowIndex}_col_${i}`;
              field.textContent = '–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞';
              cell.appendChild(field);
              newRow.appendChild(cell);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å –∫–Ω–æ–ø–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è
            const actionCell = document.createElement('td');
            actionCell.className = 'text-end';
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-sm btn-outline-danger delete-row-btn';
            deleteBtn.dataset.rowIndex = rowIndex;
            deleteBtn.textContent = '√ó';
            actionCell.appendChild(deleteBtn);
            newRow.appendChild(actionCell);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏
            deleteBtn.addEventListener('click', function() {
              tbody.deleteRow(rowIndex);

              // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã
              tbody.querySelectorAll('.delete-row-btn').forEach((btn, i) => {
                btn.dataset.rowIndex = i;
              });

              saveBlock(block);
            });

            tbody.appendChild(newRow);
            saveBlock(block);
          });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        const addColBtn = block.querySelector('.add-column');
        if (addColBtn) {
          addColBtn.addEventListener('click', function() {
            const thead = block.querySelector('thead');
            const tbody = block.querySelector('tbody');
            const colIndex = thead.rows[0].cells.length - 1; // –ü—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const newHeader = document.createElement('th');

            const headerContent = document.createElement('div');
            headerContent.className = 'd-flex justify-content-between align-items-center';

            const headerField = document.createElement('div');
            headerField.className = 'editable-field';
            headerField.contentEditable = true;
            headerField.dataset.field = `header_${colIndex}`;
            headerField.textContent = '–ù–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü';

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-sm btn-outline-danger delete-col-btn';
            deleteBtn.dataset.colIndex = colIndex;
            deleteBtn.textContent = '√ó';

            headerContent.appendChild(headerField);
            headerContent.appendChild(deleteBtn);
            newHeader.appendChild(headerContent);

            // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            thead.rows[0].insertBefore(newHeader, thead.rows[0].lastElementChild);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏
            deleteBtn.addEventListener('click', function() {
              thead.rows[0].deleteCell(colIndex);

              tbody.querySelectorAll('tr').forEach(row => {
                row.deleteCell(colIndex);
              });

              saveBlock(block);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫–∏ –≤–æ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
            tbody.querySelectorAll('tr').forEach((row, rowIndex) => {
              const cell = document.createElement('td');

              const cellContent = document.createElement('div');
              cellContent.className = 'd-flex justify-content-between align-items-center';

              const field = document.createElement('div');
              field.className = 'editable-field';
              field.contentEditable = true;
              field.dataset.field = `row_${rowIndex}_col_${colIndex}`;
              field.textContent = '–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ';

              cellContent.appendChild(field);

              // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–π —è—á–µ–π–∫–∏ –≤ —Å—Ç—Ä–æ–∫–µ
              if (colIndex === 0) {
                const deleteRowBtn = document.createElement('button');
                deleteRowBtn.className = 'btn btn-sm btn-outline-danger delete-row-btn';
                deleteRowBtn.dataset.rowIndex = rowIndex;
                deleteRowBtn.textContent = '√ó';
                cellContent.appendChild(deleteRowBtn);

                deleteRowBtn.addEventListener('click', function() {
                  tbody.deleteRow(rowIndex);
                  saveBlock(block);
                });
              }

              cell.appendChild(cellContent);
              row.insertBefore(cell, row.lastElementChild);
            });

            saveBlock(block);
          });
        }

        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–ª–æ–∫–∞
        const deleteBtn = block.querySelector('.delete-block');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫?')) {
                    fetch(`/block/${block.dataset.blockId}/delete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.csrfToken
                        }
                    })
                    .then(() => block.remove());
                }
            });
        }

        // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
        const addItemBtn = block.querySelector('.add-item-btn');
        if (addItemBtn) {
            addItemBtn.addEventListener('click', function() {
                const itemsContainer = block.querySelector('.items-container');
                const itemCount = itemsContainer.querySelectorAll('.item').length;

                const newItemHtml = `
                    <div class="item mb-2 p-2 border">
                        <div class="d-flex justify-content-between">
                            <div>
                                <span class="editable-field" contenteditable="true"
                                      data-field="item${itemCount}.name">
                                    –ù–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç
                                </span>
                            </div>
                            <button class="btn btn-sm btn-danger delete-item">√ó</button>
                        </div>
                        <div class="row mt-1">
                            <div class="col">
                                <label>–ö–æ–ª-–≤–æ:</label>
                                <span class="editable-field" contenteditable="true"
                                      data-field="item${itemCount}.quantity">
                                    1
                                </span>
                            </div>
                            <div class="col">
                                <label>–í–µ—Å:</label>
                                <span class="editable-field" contenteditable="true"
                                      data-field="item${itemCount}.weight">
                                    0.1
                                </span> –∫–≥
                            </div>
                        </div>
                    </div>
                `;

                itemsContainer.insertAdjacentHTML('beforeend', newItemHtml);

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ –ø–æ–ª–µ
                const newItem = itemsContainer.lastElementChild;
                makeContentEditable(newItem);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞
                newItem.querySelector('.delete-item').addEventListener('click', function() {
                    newItem.remove();
                    saveBlock(block);
                });

                saveBlock(block);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        block.querySelectorAll('.delete-item').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.item').remove();
                saveBlock(block);
            });
        });
    }

    // 6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤
    function initBlocks() {
        document.querySelectorAll('.block').forEach(block => {
            makeBlockDraggable(block);
            makeBlockResizable(block);
            makeContentEditable(block);
            initActionButtons(block);
        });
    }

    // 7. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
    function initAddBlockButtons() {
        document.querySelectorAll('.block-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.dataset.type;
                addNewBlock(type);
            });
        });
    }

    // 8. –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
    function addNewBlock(type) {
        const boardRect = board.getBoundingClientRect();
        const x = boardRect.width / 2 - 125;
        const y = boardRect.height / 2 - 75;

        fetch(`/character/${characterId}/add_block`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrfToken
            },
            body: JSON.stringify({
                type: type,
                position_x: x,
                position_y: y
            })
        })
        .then(response => response.json())
        .then(data => {
            const blockElement = document.createElement('div');
            blockElement.className = 'block';
            blockElement.dataset.blockId = data.id;
            blockElement.dataset.blockType = data.type;
            blockElement.style.left = `${x}px`;
            blockElement.style.top = `${y}px`;
            blockElement.style.width = '300px';
            blockElement.style.height = '200px';
            blockElement.style.backgroundColor = '#ffffff';

            if (type === 'table') {
                blockElement.innerHTML = `
                    <div class="block-header">
                      <div class="block-title editable-field" contenteditable="true" data-field="name">
                        –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
                      </div>
                      <div class="block-actions">
                        <button class="btn btn-sm btn-outline-secondary color-trigger">üé®</button>
                        <button class="btn btn-sm btn-danger delete-block">√ó</button>
                      </div>
                    </div>
                    <div class="block-content">
                      <div class="table-responsive">
                        <table class="table table-sm">
                          <thead>
                            <tr>
                              <th>
                                <div class="d-flex justify-content-between align-items-center">
                                  <div class="editable-field" contenteditable="true"
                                       data-field="header_0">–ù–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü</div>
                                  <button class="btn btn-sm btn-outline-danger delete-col-btn action-button"
                                          data-col-index="0">√ó</button>
                                </div>
                              </th>
                              <th class="align-middle">
                                <button class="btn btn-sm btn-outline-success add-column action-button">+</button>
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr class="table-row">
                              <td>
                                <div class="editable-field" contenteditable="true"
                                     data-field="row_0_col_0">–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞</div>
                              </td>
                              <td class="align-middle text-center">
                                <button class="btn btn-sm btn-outline-danger delete-row-btn action-button"
                                        data-row-index="0">√ó</button>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                        <button class="btn btn-sm btn-outline-primary add-row mt-2">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
                      </div>
                    </div>
                    <div class="color-picker" style="display: none;">
                      <!-- —Ü–≤–µ—Ç–∞ -->
                    </div>
                  `;
            } else {
                // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                          blockElement.innerHTML = `
                              <div class="block-header">
                                  <div class="block-title editable-field" contenteditable="true" data-field="name">
                                      –ù–æ–≤—ã–π –±–ª–æ–∫ (${type})
                                  </div>
                                  <div class="block-actions">
                                      <button class="btn btn-sm btn-outline-secondary color-trigger">üé®</button>
                                      <button class="btn btn-sm btn-danger delete-block">√ó</button>
                                  </div>
                              </div>
                              <div class="block-content">
                                  <div class="editable-field" contenteditable="true" data-field="content">
                                      –í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ...
                                  </div>
                              </div>
                              <div class="color-picker" style="display: none;">
                                  ${['#ffffff', '#ffebee', '#f3e5f5', '#e8eaf6', '#e3f2fd', '#e0f7fa', '#e8f5e9', '#fffde7', '#fff3e0', '#efebe9']
                                      .map(color => `<div class="color-option" style="background-color: ${color};" data-color="${color}"></div>`)
                                      .join('')}
                              </div>
                          `;
            }

            board.appendChild(blockElement);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–ª–æ–∫
            makeBlockDraggable(blockElement);
            makeBlockResizable(blockElement);
            makeContentEditable(blockElement);
            initActionButtons(blockElement);
        });
    }

    // 9. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    document.querySelector('form[method="POST"]').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –±–ª–æ–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
        const blocks = document.querySelectorAll('.block');
        let saveCount = 0;

        blocks.forEach(block => {
            saveBlock(block);
            saveCount++;
        });

        // –ï—Å–ª–∏ –Ω–µ—Ç –±–ª–æ–∫–æ–≤, —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
        if (saveCount === 0) {
            form.submit();
            return;
        }

        // –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
        setTimeout(() => {
            form.submit();
        }, 1000);
    });

    // 10. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    initBlocks();
    initAddBlockButtons();
});
</script>
{% endblock %}